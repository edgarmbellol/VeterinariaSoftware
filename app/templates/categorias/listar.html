{% extends "base.html" %}

{% block title %}Categorías - Veterinaria{% endblock %}

{% block content %}
<div x-data="categoriasApp()" x-cloak>
    <!-- Encabezado con acciones principales -->
    <div class="bg-gradient-to-r from-green-600 to-green-800 text-white rounded-lg shadow-lg mb-6 p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-3xl font-bold mb-2">
                    <i class="fas fa-folder mr-3"></i>Categorías
                </h2>
                <p class="text-green-100">Organiza tus productos por categorías</p>
            </div>
            <a href="{{ url_for('categorias.crear') }}" 
               class="bg-white text-green-600 px-6 py-3 rounded-lg font-bold text-lg hover:bg-green-50 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-2xl"></i>
                <span>NUEVA CATEGORÍA</span>
            </a>
        </div>
    </div>

    <!-- Barra de búsqueda -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label class="block text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-search mr-2 text-green-600"></i>Buscar Categoría
                </label>
                <input type="text" 
                       x-model="busqueda"
                       @input="filtrarCategorias()"
                       placeholder="Escribe el nombre de la categoría..."
                       class="w-full px-5 py-4 text-lg border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-green-500 focus:border-green-500 transition-all">
            </div>
            <div class="flex items-end">
                <button @click="limpiarBusqueda()" 
                        class="px-6 py-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold text-lg">
                    <i class="fas fa-redo mr-2"></i>Limpiar
                </button>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay categorías -->
    <template x-if="categoriasFiltradas.length === 0">
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">No hay categorías</h3>
            <p class="text-gray-500 mb-6">Crea categorías para organizar tus productos</p>
            <a href="{{ url_for('categorias.crear') }}" 
               class="inline-block bg-green-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-all shadow-lg">
                <i class="fas fa-plus-circle mr-2"></i>Crear Primera Categoría
            </a>
        </div>
    </template>

    <!-- Grid de categorías en tarjetas grandes -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="categoriasFiltradas.length > 0">
        <template x-for="categoria in categoriasFiltradas" :key="categoria.id">
            <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all transform hover:scale-105 border-2 border-gray-100">
                <!-- Encabezado de la tarjeta -->
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-5 rounded-t-xl">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <i class="fas fa-folder text-3xl mr-3"></i>
                            <h3 class="text-2xl font-bold" x-text="categoria.nombre"></h3>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold"
                              :class="categoria.activa ? 'bg-white text-green-600' : 'bg-gray-300 text-gray-600'"
                              x-text="categoria.activa ? '✓ Activa' : '✗ Inactiva'">
                        </span>
                    </div>
                </div>

                <!-- Cuerpo de la tarjeta -->
                <div class="p-5">
                    <!-- Descripción -->
                    <template x-if="categoria.descripcion">
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600" x-text="categoria.descripcion"></p>
                        </div>
                    </template>
                    <template x-if="!categoria.descripcion">
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-400 italic">Sin descripción</p>
                        </div>
                    </template>

                    <!-- Fecha de creación -->
                    <div class="mb-4 text-sm text-gray-500">
                        <i class="fas fa-calendar mr-2"></i>
                        <span x-text="'Creada: ' + formatearFecha(categoria.fecha_creacion)"></span>
                    </div>

                    <!-- Información de productos -->
                    <div class="mb-5 p-3 bg-blue-50 rounded-lg">
                        <div class="text-sm font-semibold text-blue-800">
                            <i class="fas fa-box mr-2"></i>
                            <span x-text="categoria.productos_count + ' producto(s)'"></span>
                        </div>
                    </div>

                    <!-- Botones de acción grandes y claros -->
                    <div class="flex gap-2">
                        <a :href="'/categorias/editar/' + categoria.id" 
                           class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors text-center">
                            <i class="fas fa-edit mr-2"></i>Editar
                        </a>
                        <button @click="confirmarEliminar(categoria.id, categoria.nombre)"
                                class="bg-red-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function categoriasApp() {
    return {
        categorias: [
            {% for categoria in categorias %}
            {
                id: {{ categoria.id }},
                nombre: {{ categoria.nombre | tojson | safe }},
                descripcion: {{ (categoria.descripcion or '') | tojson | safe }},
                activa: {{ 'true' if categoria.activa else 'false' }},
                fecha_creacion: {{ (categoria.fecha_creacion.strftime('%Y-%m-%d') if categoria.fecha_creacion else '') | tojson | safe }},
                productos_count: {{ categoria.productos|length if categoria.productos else 0 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        busqueda: '',
        categoriasFiltradas: [],

        init() {
            this.categoriasFiltradas = this.categorias;
        },

        filtrarCategorias() {
            const termino = this.busqueda.toLowerCase().trim();
            if (!termino) {
                this.categoriasFiltradas = this.categorias;
                return;
            }

            this.categoriasFiltradas = this.categorias.filter(c => {
                const nombre = (c.nombre || '').toLowerCase();
                const descripcion = (c.descripcion || '').toLowerCase();
                
                return nombre.includes(termino) || descripcion.includes(termino);
            });
        },

        limpiarBusqueda() {
            this.busqueda = '';
            this.categoriasFiltradas = this.categorias;
        },

        formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        },

        confirmarEliminar(id, nombre) {
            if (confirm(`¿Estás seguro de eliminar la categoría "${nombre}"?\n\nEsta acción no se puede deshacer.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/categorias/eliminar/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }
    }
}
</script>
{% endblock %}
