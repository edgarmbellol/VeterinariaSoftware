{% extends "base.html" %}

{% block title %}Productos - Veterinaria{% endblock %}

{% block content %}
<div x-data="productosApp()" x-cloak>
    <!-- Encabezado con acciones principales -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg mb-6 p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-3xl font-bold mb-2">
                    <i class="fas fa-box mr-3"></i>Productos
                </h2>
                <p class="text-blue-100">Gestiona tu inventario de productos</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('productos.crear') }}" 
                   class="bg-white text-blue-600 px-6 py-3 rounded-lg font-bold text-lg hover:bg-blue-50 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-2xl"></i>
                    <span>NUEVO PRODUCTO</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda grande y clara -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label class="block text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-search mr-2 text-blue-600"></i>Buscar Producto
                </label>
                <input type="text" 
                       x-model="busqueda"
                       @input="filtrarProductos()"
                       placeholder="Escribe el nombre, código o categoría del producto..."
                       class="w-full px-5 py-4 text-lg border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
            </div>
            <div class="flex items-end">
                <button @click="limpiarBusqueda()" 
                        class="px-6 py-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold text-lg">
                    <i class="fas fa-redo mr-2"></i>Limpiar
                </button>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay productos -->
    <template x-if="productosFiltrados.length === 0">
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">No hay productos</h3>
            <p class="text-gray-500 mb-6">Comienza agregando tu primer producto</p>
            <a href="{{ url_for('productos.crear') }}" 
               class="inline-block bg-blue-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-all shadow-lg">
                <i class="fas fa-plus-circle mr-2"></i>Crear Primer Producto
            </a>
        </div>
    </template>

    <!-- Grid de productos en tarjetas grandes -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="productosFiltrados.length > 0">
        <template x-for="producto in productosFiltrados" :key="producto.id">
            <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all transform hover:scale-105 border-2 border-gray-100">
                <!-- Encabezado de la tarjeta -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-xl">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-1" x-text="producto.nombre"></h3>
                            <p class="text-blue-100 text-sm" x-text="producto.categoria || 'Sin categoría'"></p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold" x-text="'$' + formatoNumero(producto.precio_venta)"></div>
                            <p class="text-xs text-blue-100">Precio de venta</p>
                        </div>
                    </div>
                </div>

                <!-- Cuerpo de la tarjeta -->
                <div class="p-5">
                    <!-- Código de barras -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">
                            <i class="fas fa-barcode mr-1"></i>Código de Barras
                        </div>
                        <div class="font-mono font-bold text-gray-800" x-text="producto.codigo_barras"></div>
                    </div>

                    <!-- Descripción -->
                    <template x-if="producto.descripcion">
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 line-clamp-2" x-text="producto.descripcion"></p>
                        </div>
                    </template>

                    <!-- Stock con indicador visual -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-700">
                                <i class="fas fa-warehouse mr-1"></i>Stock Disponible
                            </span>
                            <span class="px-3 py-1 rounded-full text-sm font-bold"
                                  :class="{
                                      'bg-red-100 text-red-800': producto.stock <= producto.stock_minimo,
                                      'bg-yellow-100 text-yellow-800': producto.stock > producto.stock_minimo && producto.stock <= producto.stock_minimo * 2,
                                      'bg-green-100 text-green-800': producto.stock > producto.stock_minimo * 2
                                  }"
                                  x-text="producto.stock + ' unidades'">
                            </span>
                        </div>
                        <template x-if="producto.stock_minimo > 0">
                            <div class="text-xs text-gray-500">
                                Mínimo: <span x-text="producto.stock_minimo"></span> unidades
                            </div>
                        </template>
                    </div>

                    <!-- Estado -->
                    <div class="mb-4">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold"
                              :class="producto.activo ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                              x-text="producto.activo ? '✓ Activo' : '✗ Inactivo'">
                        </span>
                    </div>

                    <!-- Botones de acción grandes y claros -->
                    <div class="flex gap-2 mt-5">
                        <a :href="'/productos/editar/' + producto.id" 
                           class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-center">
                            <i class="fas fa-edit mr-2"></i>Editar
                        </a>
                        <button @click="confirmarEliminar(producto.id, producto.nombre)"
                                class="bg-red-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal de Recibir Pedido -->
    <div x-show="mostrarModalRecibirPedido" 
         x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.away="cerrarModalRecibirPedido()">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-truck mr-2 text-green-600"></i>Recibir Pedido
                </h3>
                <button @click="cerrarModalRecibirPedido()" 
                        class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Búsqueda de producto -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-barcode mr-2"></i>Buscar Producto
                </label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        x-model="busquedaPedido"
                        @keyup.enter="buscarProductoParaPedido()"
                        @input="buscarProductoParaPedido()"
                        placeholder="Escanea código de barras o busca por nombre..."
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg"
                        autofocus
                    >
                    <button @click="buscarProductoParaPedido()" 
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Lista de productos encontrados -->
            <div x-show="buscandoProducto" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-green-600"></i>
                <p class="mt-2 text-gray-600">Buscando productos...</p>
            </div>

            <div x-show="!buscandoProducto && productosEncontradosPedido.length === 0 && busquedaPedido.length > 0" 
                 class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-4xl mb-2 block"></i>
                No se encontraron productos
            </div>

            <div x-show="!buscandoProducto && busquedaPedido.length === 0" 
                 class="text-center py-8 text-gray-500">
                <i class="fas fa-info-circle text-4xl mb-2 block"></i>
                Escanea el código de barras o busca por nombre para agregar productos al pedido
            </div>

            <!-- Lista de productos para agregar cantidad -->
            <div x-show="!buscandoProducto && productosEncontradosPedido.length > 0" 
                 class="space-y-3 mb-6">
                <template x-for="producto in productosEncontradosPedido" :key="producto.id">
                    <div class="p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-colors">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900" x-text="producto.nombre"></div>
                                <div class="text-sm text-gray-500 mt-1">
                                    <span x-text="'Código: ' + producto.codigo_barras"></span>
                                    <span class="mx-2">•</span>
                                    <span x-text="'Stock actual: ' + producto.stock"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-700">Cantidad a agregar:</label>
                            <div class="flex items-center">
                                <button @click="decrementarCantidadPedido(producto)" 
                                        class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-l">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <input 
                                    type="number" 
                                    x-model="producto.cantidad_agregar"
                                    @input="validarCantidadPedido(producto)"
                                    min="1"
                                    class="w-20 px-2 py-2 text-center border-t border-b border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
                                >
                                <button @click="incrementarCantidadPedido(producto)" 
                                        class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-r">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                            <div class="flex-1 text-right">
                                <span class="text-sm text-gray-600">Nuevo stock: </span>
                                <span class="font-bold text-green-600" 
                                      x-text="(parseInt(producto.stock) || 0) + (parseInt(producto.cantidad_agregar) || 0)"></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Resumen del pedido -->
            <div x-show="getProductosEnPedido().length > 0" 
                 class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 class="font-semibold text-gray-900 mb-3">
                    <i class="fas fa-list mr-2"></i>Resumen del Pedido
                </h4>
                <div class="space-y-2">
                    <template x-for="item in getProductosEnPedido()" :key="item.id">
                        <div class="flex justify-between items-center text-sm">
                            <span x-text="item.nombre + ' (+' + item.cantidad_agregar + ')'"></span>
                            <span class="font-semibold" x-text="'Stock: ' + item.stock + ' → ' + (parseInt(item.stock) + parseInt(item.cantidad_agregar))"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="flex justify-end space-x-3">
                <button @click="cerrarModalRecibirPedido()" 
                        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancelar
                </button>
                <button @click="procesarPedido()" 
                        :disabled="getProductosEnPedido().length === 0 || procesandoPedido"
                        :class="getProductosEnPedido().length === 0 || procesandoPedido ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                        class="px-6 py-2 text-white rounded-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>
                    <span x-text="procesandoPedido ? 'Procesando...' : 'Recibir Pedido'"></span>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
function productosApp() {
    return {
        productos: [
            {% for producto in productos %}
            {
                id: {{ producto.id }},
                nombre: {{ producto.nombre | tojson | safe }},
                codigo_barras: {{ producto.codigo_barras | tojson | safe }},
                descripcion: {{ (producto.descripcion or '') | tojson | safe }},
                precio_venta: {{ producto.precio_venta }},
                stock: {{ producto.stock }},
                stock_minimo: {{ producto.stock_minimo or 0 }},
                categoria: {{ (producto.categoria_rel.nombre if producto.categoria_rel else 'Sin categoría') | tojson | safe }},
                activo: {{ 'true' if producto.activo else 'false' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        busqueda: '',
        productosFiltrados: [],
        mostrarModalRecibirPedido: false,
        busquedaPedido: '',
        productosEncontradosPedido: [],
        buscandoProducto: false,
        productosEnPedido: [],
        procesandoPedido: false,

        init() {
            this.productosFiltrados = this.productos;
        },

        filtrarProductos() {
            const termino = this.busqueda.toLowerCase().trim();
            if (!termino) {
                this.productosFiltrados = this.productos;
                return;
            }

            this.productosFiltrados = this.productos.filter(p => {
                const nombre = (p.nombre || '').toLowerCase();
                const codigo = (p.codigo_barras || '').toLowerCase();
                const categoria = (p.categoria || '').toLowerCase();
                const descripcion = (p.descripcion || '').toLowerCase();
                
                return nombre.includes(termino) || 
                       codigo.includes(termino) || 
                       categoria.includes(termino) ||
                       descripcion.includes(termino);
            });
        },

        limpiarBusqueda() {
            this.busqueda = '';
            this.productosFiltrados = this.productos;
        },

        formatoNumero(num) {
            return new Intl.NumberFormat('es-CO').format(Math.round(num));
        },

        confirmarEliminar(id, nombre) {
            if (confirm(`¿Estás seguro de eliminar el producto "${nombre}"?\n\nEsta acción no se puede deshacer.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/productos/eliminar/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        },

        abrirModalRecibirPedido() {
            this.mostrarModalRecibirPedido = true;
            this.busquedaPedido = '';
            this.productosEncontradosPedido = [];
            this.productosEnPedido = [];
        },

        cerrarModalRecibirPedido() {
            this.mostrarModalRecibirPedido = false;
            this.busquedaPedido = '';
            this.productosEncontradosPedido = [];
            this.productosEnPedido = [];
        },

        async buscarProductoParaPedido() {
            const busqueda = this.busquedaPedido.trim();
            if (!busqueda || busqueda.length < 2) {
                this.productosEncontradosPedido = [];
                this.buscandoProducto = false;
                return;
            }

            this.buscandoProducto = true;
            try {
                // Primero intentar buscar por código de barras
                const responseCodigo = await fetch(`/productos/api/buscar?codigo=${encodeURIComponent(busqueda)}`);
                if (responseCodigo.ok) {
                    const producto = await responseCodigo.json();
                    // Agregar cantidad_agregar al producto
                    producto.cantidad_agregar = 1;
                    this.productosEncontradosPedido = [producto];
                    this.buscandoProducto = false;
                    this.busquedaPedido = '';
                    return;
                }

                // Si no se encuentra por código, buscar por nombre (incluye productos sin stock)
                const responseNombre = await fetch(`/productos/api/buscar-nombre?nombre=${encodeURIComponent(busqueda)}`);
                if (responseNombre.ok) {
                    const productos = await responseNombre.json();
                    // Agregar cantidad_agregar a cada producto
                    this.productosEncontradosPedido = productos.map(p => ({
                        ...p,
                        cantidad_agregar: 1
                    }));
                } else {
                    this.productosEncontradosPedido = [];
                }
            } catch (error) {
                console.error('Error al buscar producto:', error);
                this.productosEncontradosPedido = [];
            } finally {
                this.buscandoProducto = false;
            }
        },

        incrementarCantidadPedido(producto) {
            if (!producto.cantidad_agregar) {
                producto.cantidad_agregar = 1;
            } else {
                producto.cantidad_agregar = parseInt(producto.cantidad_agregar) + 1;
            }
        },

        decrementarCantidadPedido(producto) {
            if (producto.cantidad_agregar && parseInt(producto.cantidad_agregar) > 1) {
                producto.cantidad_agregar = parseInt(producto.cantidad_agregar) - 1;
            } else {
                producto.cantidad_agregar = 1;
            }
        },

        validarCantidadPedido(producto) {
            if (!producto.cantidad_agregar || parseInt(producto.cantidad_agregar) < 1) {
                producto.cantidad_agregar = 1;
            }
        },

        getProductosEnPedido() {
            return this.productosEncontradosPedido.filter(p => p.cantidad_agregar && parseInt(p.cantidad_agregar) > 0);
        },

        async procesarPedido() {
            const productosEnPedido = this.getProductosEnPedido();
            if (productosEnPedido.length === 0) {
                alert('Agrega al menos un producto al pedido');
                return;
            }

            this.procesandoPedido = true;

            try {
                const items = productosEnPedido.map(p => ({
                    producto_id: p.id,
                    cantidad: parseInt(p.cantidad_agregar)
                }));

                const response = await fetch('/productos/api/recibir-pedido', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items: items })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(data.error || 'Error al procesar el pedido');
                    this.procesandoPedido = false;
                    return;
                }

                alert(`Pedido recibido exitosamente\nSe actualizó el stock de ${data.productos_actualizados} producto(s)`);
                
                // Recargar la página para actualizar los stocks
                window.location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar el pedido');
                this.procesandoPedido = false;
            }
        }
    }
}
</script>
{% endblock %}
